name: CI/CD to AWS Elastic Beanstalk (us-east-2 SOP)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      APP_NAME: ${{ secrets.APP_NAME }}
      EB_ENV_NAME: ${{ secrets.EB_ENV_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Build and Package (SOP-safe)
        shell: bash
        run: |
          set -euo pipefail
          echo "===== BUILD & PACKAGE START ====="

          if [ -z "${APP_NAME:-}" ] || [[ "$APP_NAME" =~ ^[*]+$ ]]; then
            echo "⚠️ APP_NAME is empty or masked; using fallback"
            APP_NAME="groweasy-invoice-app"
          fi

          APP_NAME=$(echo "$APP_NAME" | tr -cd '[:alnum:]-_')
          TIMESTAMP=$(date +'%Y%m%d%H%M%S')
          ZIP_NAME="${APP_NAME}-build-${TIMESTAMP}.zip"
          ARTIFACT_PATH="dist/$ZIP_NAME"
          ARTIFACT_KEY="$ZIP_NAME"

          echo "✅ App: $APP_NAME"
          echo "✅ Artifact: $ARTIFACT_KEY"
          mkdir -p dist
          zip -r "$ARTIFACT_PATH" . -x "*.git*" "dist/*"

          echo "Uploading to s3://$S3_BUCKET/$ARTIFACT_KEY ..."
          aws s3 cp "$ARTIFACT_PATH" "s3://$S3_BUCKET/$ARTIFACT_KEY"

          echo "✅ Uploaded successfully"
          printf "ARTIFACT_KEY=%s\n" "$ARTIFACT_KEY" >> "$GITHUB_ENV"

      - name: Diagnostic Preflight (S3 + IAM)
        run: |
          set -euo pipefail
          echo "===== PREFLIGHT ====="
          aws sts get-caller-identity
          aws s3 ls "s3://$S3_BUCKET/$ARTIFACT_KEY"
          aws s3api head-object --bucket "$S3_BUCKET" --key "$ARTIFACT_KEY"
          echo "===== PREFLIGHT COMPLETE ====="

      - name: Create new EB Application Version
        shell: bash
        run: |
          set -euo pipefail
          echo "===== CREATING EB APPLICATION VERSION ====="
          VERSION_LABEL="v$(date +'%Y%m%d%H%M%S')-$(git rev-parse --short HEAD)"
          echo "VERSION_LABEL=$VERSION_LABEL" >> "$GITHUB_ENV"
          echo "Version Label: $VERSION_LABEL"
          aws elasticbeanstalk create-application-version \
            --application-name "$APP_NAME" \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket="$S3_BUCKET",S3Key="$ARTIFACT_KEY"
          echo "✅ EB Application version created."

      - name: Deploy to EB Environment
        shell: bash
        run: |
          set -euo pipefail
          echo "===== DEPLOY TO ENVIRONMENT ====="
          echo "Using version: $VERSION_LABEL"
          aws elasticbeanstalk update-environment \
            --environment-name "$EB_ENV_NAME" \
            --version-label "$VERSION_LABEL"
          echo "✅ Deployment initiated."

      - name: Validate Deployment
        shell: bash
        run: |
          set -euo pipefail
          echo "===== VALIDATING ENVIRONMENT ====="
          aws elasticbeanstalk wait environment-updated --environment-names "$EB_ENV_NAME"
          aws elasticbeanstalk describe-environments \
            --environment-names "$EB_ENV_NAME" \
            --query "Environments[0].Status"
          echo "✅ Environment update complete."
