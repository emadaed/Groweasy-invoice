<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GrowEasy Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/invoice.css') }}">
</head>
<body>
  <div class="invoice-container container py-3">
    <header class="invoice-header row align-items-center mb-3">
      <div class="col-3">
        {% if data.logo_b64 %}
          <img src="data:image/png;base64,{{ data.logo_b64 }}" class="logo img-fluid" alt="Logo">
        {% endif %}
      </div>
      <div class="col-9 text-end">
        <h2 class="mb-0">GrowEasy Invoice</h2>
        <small class="text-muted">Generated by GrowEasy</small>
      </div>
    </header>

    {% if preview %}
      <div class="mb-3">
        <form id="downloadForm" method="post" action="{{ url_for('download_invoice') }}">
          <input type="hidden" name="data" id="downloadDataField" />
          <button type="button" class="btn btn-primary" onclick="submitDownload()">Download PDF</button>
        </form>
      </div>
      <script>
        function submitDownload() {
          const field = document.getElementById('downloadDataField');
          const payload = {{ data | tojson | safe }};
          payload.qr_b64 = "{{ qr_b64|default('') }}";
          field.value = JSON.stringify(payload);
          document.getElementById('downloadForm').submit();
        }
      </script>
    {% endif %}

    <section class="customer mb-3">
      <p><strong>Customer:</strong> {{ data.client_name }}</p>
      <p><strong>Invoice No:</strong> {{ data.invoice_number }}</p>
      <p><strong>Date:</strong> {{ data.invoice_date }}</p>
    </section>

    <table class="table table-sm table-bordered items">
      <thead class="table-light">
        <tr>
          <th>Item</th>
          <th class="text-end">Qty</th>
          <th class="text-end">Price</th>
          <th class="text-end">Total</th>
        </tr>
      </thead>
      <tbody>
        {% set items_list = data.get('items') if data and 'items' in data else [] %}
        {% for item in items_list %}
          <tr>
            <td>{{ item.name }}</td>
            <td class="text-end">{{ item.qty }}</td>
            <td class="text-end">{{ '%.2f' % item.price }}</td>
            <td class="text-end">{{ '%.2f' % item.total }}</td>
          </tr>
        {% else %}
          <tr><td colspan="4" class="text-center text-muted">No items</td></tr>
        {% endfor %}
      </tbody>
      <tfoot class="table-light">
        <tr><td colspan="3" class="text-end"><strong>Grand Total:</strong></td>
            <td class="text-end"><strong>{{ '%.2f' % data.total }}</strong></td></tr>
      </tfoot>
    </table>

    <footer class="invoice-footer mt-4 d-flex justify-content-between align-items-center">
      <div class="qr">
        {% if qr_b64 %}
          <img src="{{ qr_b64 }}" alt="QR Code" class="img-fluid" />
        {% endif %}
      </div>
      <p class="thankyou mb-0 text-end flex-grow-1">Thank you for choosing GrowEasy!</p>
    </footer>
  </div>
</body>
</html>
