<!-- templates/create_po.html - COMPLETE FIXED VERSION -->
{% extends "base.html" %}

{% block title %}Create Purchase Order{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h2 class="fw-bold">Create Purchase Order</h2>
        <p class="text-muted fs-5">Order from suppliers, track deliveries, manage inventory</p>
    </div>

    <form method="POST" action="{{ url_for('create_po_process') }}" enctype="multipart/form-data" id="poForm">
        <input type="hidden" name="document_type" value="purchase_order">

        <!-- Supplier & Your Business Info -->
        <div class="row g-5 mb-4">
            <!-- Supplier Column -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Supplier Information</h5>
                    </div>
                    <div class="card-body">
                        <!-- Supplier Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Select Existing Supplier</label>
                            <select class="form-select mb-3" id="supplierSelect">
                                <option value="">-- Select Supplier --</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}"
                                        data-name="{{ supplier.name }}"
                                        data-email="{{ supplier.email }}"
                                        data-phone="{{ supplier.phone }}"
                                        data-address="{{ supplier.address }}"
                                        data-tax="{{ supplier.tax_id }}">
                                    {{ supplier.name }} ({{ supplier.order_count }} orders)
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="showSupplierForm">
                                + Add New Supplier
                            </button>
                        </div>

                        <!-- Supplier Form -->
                        <div id="newSupplierForm" class="collapse">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Supplier Name *</label>
                                    <input type="text" name="supplier_name" id="supplierName" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Contact Person</label>
                                    <input type="text" name="contact_person" id="contactPerson" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone *</label>
                                    <input type="text" name="supplier_phone" id="supplierPhone" class="form-control">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="supplier_email" id="supplierEmail" class="form-control">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Address</label>
                                    <textarea name="supplier_address" id="supplierAddress" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Tax ID / NTN</label>
                                    <input type="text" name="supplier_tax_id" id="supplierTaxId" class="form-control" placeholder="1234567-8">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Payment Terms</label>
                                    <select name="supplier_payment_terms" id="paymentTerms" class="form-select">
                                        <option value="Net 30">Net 30</option>
                                        <option value="Net 15">Net 15</option>
                                        <option value="Due on Receipt">Due on Receipt</option>
                                        <option value="50% Advance">50% Advance</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Your Business & PO Details Column -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">PO Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">PO Number (Auto-generated)</label>
                                <input type="text" class="form-control bg-light" value="Will be auto-generated" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">PO Date *</label>
                                <input type="date" name="po_date" id="poDate" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Delivery Date</label>
                                <input type="date" name="delivery_date" id="deliveryDate" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Delivery Method</label>
                                <select name="delivery_method" id="deliveryMethod" class="form-select">
                                    <option value="Pickup">Pickup</option>
                                    <option value="Supplier Delivery">Supplier Delivery</option>
                                    <option value="Courier">Courier</option>
                                    <option value="Freight">Freight</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Shipping Terms</label>
                                <input type="text" name="shipping_terms" id="shippingTerms" class="form-control" value="FOB Destination">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">PO Status</label>
                                <select name="po_status" id="poStatus" class="form-select">
                                    <option value="draft">Draft</option>
                                    <option value="pending" selected>Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="ordered">Ordered</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Purchase Order Notes</label>
                                <textarea name="po_notes" id="poNotes" class="form-control" rows="2" placeholder="Special instructions, delivery notes, etc."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tax Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Tax Information</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Your Business NTN *</label>
                        <input type="text" name="buyer_ntn" id="buyerNtn" class="form-control"
                               value="{{ prefill_data.get('seller_ntn', '') }}" pattern="[0-9]{7}-[0-9]{1}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Supplier NTN (if registered)</label>
                        <input type="text" name="seller_ntn" id="sellerNtn" class="form-control" pattern="[0-9]{7}-[0-9]{1}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Withholding Tax (%)</label>
                        <input type="number" name="withholding_tax" id="withholdingTax" class="form-control" value="0" min="0" max="100" step="0.1">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sales Tax (%)</label>
                        <input type="number" name="sales_tax" id="salesTax" class="form-control" value="17" min="0" max="100" step="0.1">
                    </div>
                </div>
            </div>
        </div>

        <!-- PO Items Section -->
        <div class="card mb-5">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Purchase Order Items</h5>
                <div>
                    <button type="button" class="btn btn-light btn-sm me-2" id="addPOItemBtn">
                        <i class="bi bi-plus-circle"></i> Add Item
                    </button>
                    <button type="button" class="btn btn-light btn-sm" id="showInventoryModal">
                        <i class="bi bi-box-seam"></i> Add from Inventory
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="poItemsContainer">
                    <!-- Items will be added here dynamically -->
                </div>
                <div id="noPOItemsMessage" class="text-center py-5 text-muted">
                    No items added yet â€” add your first purchase item
                </div>

                <!-- PO Totals -->
                <div class="row mt-4">
                    <div class="col-md-6 offset-md-6">
                        <table class="table table-bordered">
                            <tr>
                                <td><strong>Subtotal</strong></td>
                                <td class="text-end">{{ currency_symbol }} <span id="poSubtotal">0.00</span></td>
                            </tr>
                            <tr>
                                <td><strong>Tax</strong></td>
                                <td class="text-end">{{ currency_symbol }} <span id="poTax">0.00</span></td>
                            </tr>
                            <tr>
                                <td><strong>Shipping</strong></td>
                                <td class="text-end">{{ currency_symbol }} <span id="poShipping">0.00</span></td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>Grand Total</strong></td>
                                <td class="text-end"><strong>{{ currency_symbol }} <span id="poGrandTotal">0.00</span></strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- PO Additional Details -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Shipping & Delivery</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Shipping Address</label>
                                <textarea name="shipping_address" id="shippingAddress" class="form-control" rows="3" placeholder="If different from your business address"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Shipping Cost</label>
                                <input type="number" name="shipping_cost" id="shippingCost" class="form-control" value="0" min="0" step="0.01">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Insurance</label>
                                <input type="number" name="insurance_cost" id="insuranceCost" class="form-control" value="0" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Attachments & Approval</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Attachments (Quotes, Specs)</label>
                                <input type="file" name="attachments" id="attachments" class="form-control" multiple>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Approved By</label>
                                <input type="text" name="approved_by" id="approvedBy" class="form-control" placeholder="Manager Name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Department</label>
                                <input type="text" name="department" id="department" class="form-control" placeholder="e.g., Procurement, Operations">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Internal Notes</label>
                                <textarea name="internal_notes" id="internalNotes" class="form-control" rows="2" placeholder="For internal use only"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="text-center">
            <button type="submit" name="action" value="draft" class="btn btn-outline-secondary btn-lg px-4">
                Save as Draft
            </button>
            <button type="submit" name="action" value="submit" class="btn btn-success btn-lg px-5 ms-3">
                Create Purchase Order
            </button>
            <a href="{{ url_for('purchase_orders') }}" class="btn btn-outline-danger btn-lg px-4 ms-3">
                Cancel
            </a>
        </div>
    </form>
</div>

<!-- Inventory Modal for PO Items -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Items from Inventory</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Product</th>
                                <th>SKU</th>
                                <th>Current Stock</th>
                                <th>Supplier</th>
                                <th>Last Cost</th>
                                <th>Qty to Order</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <!-- Will be populated via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addSelectedItemsBtn">Add Selected Items</button>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ nonce }}">
// JavaScript for PO functionality
window.userCurrencySymbol = "{{ currency_symbol | default('Rs.') }}";
window.poItemCounter = 0;
window.poItems = [];

// Fill supplier details when selected
function fillSupplierDetails(supplierId) {
    const option = document.querySelector(`#supplierSelect option[value="${supplierId}"]`);
    if (!option || !supplierId) return;

    document.getElementById('supplierName').value = option.dataset.name || '';
    document.getElementById('supplierEmail').value = option.dataset.email || '';
    document.getElementById('supplierPhone').value = option.dataset.phone || '';
    document.getElementById('supplierAddress').value = option.dataset.address || '';
    document.getElementById('supplierTaxId').value = option.dataset.tax || '';
}

// Add PO item
function addPOItem(item = null) {
    const container = document.getElementById('poItemsContainer');
    const noItemsMsg = document.getElementById('noPOItemsMessage');

    poItemCounter++;
    const itemId = item ? item.id : `new_${poItemCounter}`;
    const itemName = item ? item.name : '';
    const itemSKU = item ? item.sku : '';
    const itemPrice = item ? (item.cost_price || 0) : 0;
    const itemSupplier = item ? item.supplier : '';

    const html = `
    <div class="po-item card mb-3" id="po_item_${itemId}">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <input type="text" class="form-control item-name" name="items[${itemId}][name]"
                           placeholder="Item description" value="${itemName}" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control" name="items[${itemId}][sku]"
                           placeholder="SKU" value="${itemSKU}">
                </div>
                <div class="col-md-1">
                    <input type="number" class="form-control item-qty" name="items[${itemId}][qty]"
                           value="1" min="1" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control item-price" name="items[${itemId}][price]"
                           value="${itemPrice.toFixed(2)}" step="0.01" required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control item-total" name="items[${itemId}][total]"
                           value="${itemPrice.toFixed(2)}" readonly>
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" class="btn btn-danger btn-sm remove-item-btn" data-item-id="${itemId}">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <input type="text" class="form-control" name="items[${itemId}][supplier]"
                           placeholder="Supplier" value="${itemSupplier}">
                </div>
                <div class="col-md-6">
                    <textarea class="form-control" name="items[${itemId}][notes]"
                              placeholder="Notes" rows="1"></textarea>
                </div>
            </div>
        </div>
    </div>`;

    container.insertAdjacentHTML('beforeend', html);
    if (noItemsMsg) noItemsMsg.style.display = 'none';

    // Store item
    poItems.push({
        id: itemId,
        name: itemName,
        qty: 1,
        price: itemPrice,
        total: itemPrice
    });

    // Attach event listeners to new item
    attachItemListeners(itemId);
    updatePOTotals();
}

// Attach listeners to item
function attachItemListeners(itemId) {
    const itemElement = document.getElementById(`po_item_${itemId}`);
    if (!itemElement) return;

    const qtyInput = itemElement.querySelector('.item-qty');
    const priceInput = itemElement.querySelector('.item-price');
    const removeBtn = itemElement.querySelector('.remove-item-btn');

    if (qtyInput) {
        qtyInput.addEventListener('input', () => updatePOItemTotal(itemId));
    }
    if (priceInput) {
        priceInput.addEventListener('input', () => updatePOItemTotal(itemId));
    }
    if (removeBtn) {
        removeBtn.addEventListener('click', () => removePOItem(itemId));
    }
}

// Update item total
function updatePOItemTotal(itemId) {
    const itemElement = document.getElementById(`po_item_${itemId}`);
    if (!itemElement) return;

    const qty = parseFloat(itemElement.querySelector('.item-qty').value) || 0;
    const price = parseFloat(itemElement.querySelector('.item-price').value) || 0;
    const total = qty * price;

    itemElement.querySelector('.item-total').value = total.toFixed(2);

    // Update in array
    const itemIndex = poItems.findIndex(item => item.id === itemId);
    if (itemIndex !== -1) {
        poItems[itemIndex].qty = qty;
        poItems[itemIndex].price = price;
        poItems[itemIndex].total = total;
    }

    updatePOTotals();
}

// Remove item
function removePOItem(itemId) {
    const itemElement = document.getElementById(`po_item_${itemId}`);
    if (itemElement) itemElement.remove();

    poItems = poItems.filter(item => item.id !== itemId);

    const container = document.getElementById('poItemsContainer');
    const noItemsMsg = document.getElementById('noPOItemsMessage');

    if (container.children.length === 0 && noItemsMsg) {
        noItemsMsg.style.display = 'block';
    }

    updatePOTotals();
}

// Update PO totals
function updatePOTotals() {
    let subtotal = 0;
    poItems.forEach(item => {
        subtotal += item.total || 0;
    });

    const taxRate = parseFloat(document.getElementById('salesTax').value) || 0;
    const taxAmount = subtotal * (taxRate / 100);
    const shipping = parseFloat(document.getElementById('shippingCost').value) || 0;
    const grandTotal = subtotal + taxAmount + shipping;

    document.getElementById('poSubtotal').textContent = subtotal.toFixed(2);
    document.getElementById('poTax').textContent = taxAmount.toFixed(2);
    document.getElementById('poShipping').textContent = shipping.toFixed(2);
    document.getElementById('poGrandTotal').textContent = grandTotal.toFixed(2);
}

// Load inventory for modal
function loadInventoryForPO() {
    fetch('/api/inventory_items')
        .then(response => {
            if (!response.ok) throw new Error('Network error');
            return response.json();
        })
        .then(data => {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';

            if (!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No inventory items found</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = `
                <tr>
                    <td><input type="checkbox" class="form-check-input inventory-check"
                           data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'></td>
                    <td>${item.name || 'Unnamed'}</td>
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.stock || 0}</td>
                    <td>${item.supplier || 'N/A'}</td>
                    <td>${window.userCurrencySymbol}${item.cost_price || '0.00'}</td>
                    <td><input type="number" class="form-control form-control-sm order-qty" value="1" min="1"></td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        })
        .catch(error => {
            console.error('Error loading inventory:', error);
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading inventory</td></tr>';
        });
}

// Add selected inventory items
function addSelectedInventoryItems() {
    const checkboxes = document.querySelectorAll('.inventory-check:checked');
    checkboxes.forEach(checkbox => {
        try {
            const itemData = JSON.parse(checkbox.dataset.item.replace(/&#39;/g, "'"));
            const qtyInput = checkbox.closest('tr').querySelector('.order-qty');
            const qty = parseInt(qtyInput.value) || 1;

            // Create item with quantity
            const itemWithQty = {
                ...itemData,
                id: `inv_${Date.now()}_${Math.random()}`,
                qty: qty,
                price: itemData.cost_price || 0,
                total: (itemData.cost_price || 0) * qty
            };

            addPOItem(itemWithQty);
        } catch (e) {
            console.error('Error parsing item data:', e);
        }
    });

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryModal'));
    if (modal) modal.hide();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    const poDate = document.getElementById('poDate');
    if (poDate && !poDate.value) poDate.value = today;

    // Set delivery date to 7 days from now
    const deliveryDate = document.getElementById('deliveryDate');
    if (deliveryDate && !deliveryDate.value) {
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        deliveryDate.value = nextWeek.toISOString().split('T')[0];
    }

    // Add first empty item
    addPOItem();

    // Event Listeners
    document.getElementById('supplierSelect')?.addEventListener('change', function() {
        fillSupplierDetails(this.value);
    });

    document.getElementById('showSupplierForm')?.addEventListener('click', function() {
        const form = document.getElementById('newSupplierForm');
        const bsCollapse = new bootstrap.Collapse(form, { toggle: true });
    });

    document.getElementById('addPOItemBtn')?.addEventListener('click', function() {
        addPOItem();
    });

    document.getElementById('showInventoryModal')?.addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
        modal.show();
    });

    document.getElementById('addSelectedItemsBtn')?.addEventListener('click', addSelectedInventoryItems);

    document.getElementById('shippingCost')?.addEventListener('input', updatePOTotals);
    document.getElementById('salesTax')?.addEventListener('input', updatePOTotals);

    // Load inventory when modal opens
    document.getElementById('inventoryModal')?.addEventListener('show.bs.modal', loadInventoryForPO);

    // Form submission
    document.getElementById('poForm')?.addEventListener('submit', function(e) {
        // Ensure all items are properly indexed
        poItems.forEach((item, index) => {
            const itemElement = document.getElementById(`po_item_${item.id}`);
            if (itemElement) {
                const inputs = itemElement.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name && name.includes('[')) {
                        const newName = name.replace(/items\[[^\]]+\]/g, `items[${index}]`);
                        input.setAttribute('name', newName);
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}